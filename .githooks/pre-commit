#!/bin/sh
#
# Pre-commit hook for Bagel Browser
# Runs tests, formatting, and linting before allowing commits
#

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if Cargo.toml exists
if [ ! -f "Cargo.toml" ]; then
    echo "âŒ Cargo.toml not found. Are you in the right directory?"
    exit 1
fi

# Run cargo fmt --check
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt -- --check; then
    echo "âŒ Code formatting issues found. Run 'cargo fmt' to fix them."
    exit 1
fi

# Run cargo clippy
echo "ğŸ”§ Running clippy lints..."
if ! cargo clippy -- -D warnings; then
    echo "âŒ Clippy found issues. Please fix them before committing."
    exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
if ! cargo test; then
    echo "âŒ Tests failed. Please fix them before committing."
    exit 1
fi

# Check for common security issues
echo "ğŸ”’ Checking for potential security issues..."
if grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.rs" src/; then
    echo "âš ï¸  Warning: Found TODO/FIXME/XXX/HACK comments. Consider addressing them."
fi

# Check for hardcoded secrets (basic check)
if grep -r -E "(password|secret|key|token)\s*=\s*[\"'][^\"']{8,}" --include="*.rs" src/ 2>/dev/null; then
    echo "âŒ Potential hardcoded secrets found. Please remove them."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
exit 0